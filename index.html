<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Hospital Overflow — animated (trolley vs ward)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  html, body { height:100%; margin:0; background:#e9f2f7; }
  #map { position:absolute; inset:0; }
  .title { position: fixed; top:12px; left:12px; z-index:9999;
    background:rgba(255,255,255,0.95); padding:10px 12px; border-radius:10px;
    box-shadow:0 2px 12px rgba(0,0,0,0.15); font-family:Arial, sans-serif; color:#333; max-width:520px; }
  .title b { font-size:16px; }
  .legend { position: fixed; bottom:20px; left:20px; z-index:9999;
    background:rgba(255,255,255,0.95); padding:12px 14px; border-radius:10px;
    box-shadow:0 2px 12px rgba(0,0,0,0.15); font-family:Arial, sans-serif; color:#333; font-size:12px; }
  .key { display:flex; align-items:center; gap:8px; margin:4px 0; }
  .dotkey { width:14px; height:14px; border-radius:50%; display:inline-block; }
  .red { background:#b22222; } .blue { background:#1f5aa6; }
  @keyframes pulseRing { 0%{transform:scale(1);opacity:.9} 50%{transform:scale(1.08);opacity:.4} 100%{transform:scale(1);opacity:.9} }
  .uhl-pulse { position:absolute;border:2px solid #ff4444;border-radius:999px;animation:pulseRing 2s ease-in-out infinite;pointer-events:none }
  .hovercard{ position:fixed; z-index:1000000; pointer-events:none; background:rgba(255,255,255,.98); border:1px solid #1f5aa6; border-radius:8px;
    box-shadow:0 8px 24px rgba(0,0,0,.25); transform-origin:top left; padding:10px 12px; font:13px/1.3 Arial,sans-serif; color:#111; display:none }
  .hovercard .h-name{font-weight:bold;margin-bottom:2px}
  .hovercard .row{display:flex;gap:8px;align-items:baseline}
  .hovercard .lab{color:#666;width:52px}
  .hovercard .val-t{color:#b22222;font-weight:bold}
  .hovercard .val-w{color:#1f5aa6;font-weight:bold}
  .hovercard .val-all{font-weight:bold}
</style>
</head>
<body>
<div id="map"></div>
<div id="card" class="hovercard"></div>
<div class="title">
  <div><b>Hospital Overflow: Trolleys (red) vs Ward Overflow (blue)</b></div>
  <div style="color:#666; font-size:12px; margin-top:4px;">“Ward overflow” ≈ admitted patients placed in overflow beds / out-of-place wards. Source: INMO Trolley/Ward Watch.</div>
</div>
<div class="legend">
  <div style="font-weight:bold; margin-bottom:6px;">Legend</div>
  <div class="key"><span class="dotkey red"></span> Trolley (ED)</div>
  <div class="key"><span class="dotkey blue"></span> Ward overflow</div>
  <div style="margin-top:8px; font-size:11px; color:#777;">Dots animate once. Hover a hospital ring or dot for details.</div>
</div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/d3@7.9.0/dist/d3.min.js"></script>

<script>
  const DATA = {"hospitals": [{"name": "St Vincent's University Hospital", "lon": -6.224, "lat": 53.318, "trolley": 547, "ward": 49, "total": 596}, {"name": "Mater Misericordiae University Hospital", "lon": -6.262, "lat": 53.36, "trolley": 366, "ward": 0, "total": 366}, {"name": "Beaumont Hospital", "lon": -6.22, "lat": 53.391, "trolley": 207, "ward": 0, "total": 207}, {"name": "Connolly Hospital, Blanchardstown", "lon": -6.386, "lat": 53.389, "trolley": 63, "ward": 0, "total": 63}, {"name": "St James’s Hospital", "lon": -6.292, "lat": 53.338, "trolley": 267, "ward": 0, "total": 267}, {"name": "Naas General Hospital", "lon": -6.666, "lat": 53.215, "trolley": 241, "ward": 12, "total": 253}, {"name": "Our Lady of Lourdes Hospital, Drogheda", "lon": -6.349, "lat": 53.717, "trolley": 278, "ward": 0, "total": 278}, {"name": "Cavan General Hospital", "lon": -7.36, "lat": 53.991, "trolley": 214, "ward": 0, "total": 214}, {"name": "Sligo University Hospital", "lon": -8.473, "lat": 54.277, "trolley": 529, "ward": 306, "total": 835}, {"name": "Letterkenny University Hospital", "lon": -7.73, "lat": 54.951, "trolley": 228, "ward": 424, "total": 652}, {"name": "Wexford General Hospital", "lon": -6.457, "lat": 52.334, "trolley": 110, "ward": 145, "total": 255}, {"name": "University Hospital Limerick", "lon": -8.652, "lat": 52.673, "trolley": 911, "ward": 1475, "total": 2386}, {"name": "Mid-Western Regional Hospital, Ennis", "lon": -8.984, "lat": 52.851, "trolley": 0, "ward": 39, "total": 39}, {"name": "University Hospital Galway", "lon": -9.062, "lat": 53.276, "trolley": 746, "ward": 261, "total": 1007}, {"name": "Mayo University Hospital", "lon": -9.297, "lat": 53.853, "trolley": 109, "ward": 227, "total": 336}, {"name": "Midland Regional Hospital, Mullingar", "lon": -7.345, "lat": 53.526, "trolley": 73, "ward": 11, "total": 84}, {"name": "Cork University Hospital", "lon": -8.553, "lat": 51.877, "trolley": 592, "ward": 127, "total": 719}, {"name": "Mercy University Hospital, Cork", "lon": -8.48, "lat": 51.897, "trolley": 128, "ward": 52, "total": 180}, {"name": "University Hospital Kerry", "lon": -9.705, "lat": 52.274, "trolley": 253, "ward": 108, "total": 361}, {"name": "University Hospital Waterford", "lon": -7.106, "lat": 52.258, "trolley": 23, "ward": 0, "total": 23}, {"name": "St Luke’s General Hospital, Kilkenny", "lon": -7.25, "lat": 52.652, "trolley": 125, "ward": 150, "total": 275}, {"name": "Our Lady's Children's Hospital, Crumlin", "lon": -6.314, "lat": 53.321, "trolley": 33, "ward": 0, "total": 33}, {"name": "Temple Street Children’s University Hospital", "lon": -6.262, "lat": 53.357, "trolley": 35, "ward": 0, "total": 35}, {"name": "National Children's Hospital, Tallaght", "lon": -6.369, "lat": 53.291, "trolley": 10, "ward": 0, "total": 10}, {"name": "Portiuncula Hospital", "lon": -8.221, "lat": 53.331, "trolley": 36, "ward": 0, "total": 36}, {"name": "Midland Regional Hospital, Portlaoise", "lon": -7.297, "lat": 53.031, "trolley": 79, "ward": 0, "total": 79}, {"name": "Bantry General Hospital", "lon": -9.448, "lat": 51.679, "trolley": 0, "ward": 29, "total": 29}, {"name": "Tipperary University Hospital", "lon": -7.7, "lat": 52.355, "trolley": 68, "ward": 78, "total": 146}, {"name": "Our Lady's Hospital, Navan", "lon": -6.681, "lat": 53.651, "trolley": 1, "ward": 0, "total": 1}, {"name": "Tallaght University Hospital", "lon": -6.372, "lat": 53.294, "trolley": 2, "ward": 0, "total": 2}], "nat": {"trolley": 6274, "ward": 3493, "total": 9767}};
  const H = DATA.hospitals || [];

  // Island bounds (safety net only)
  const ROI_BOUNDS = L.latLngBounds([[51.20,-10.80],[55.55,-5.30]]);

  // Map
  const map = L.map('map', {
    maxBounds: ROI_BOUNDS,
    maxBoundsViscosity: 1.0,
    minZoom: 6.2,
    worldCopyJump: false,
    zoomControl: true
  });

  // Hard-locked Mid-West start (option 1)
  const START_CENTER = [52.73, -8.85];
  const START_ZOOM   = 8.4;
  map.setView(START_CENTER, START_ZOOM);
  // Re-apply after render to override iframe/container sizing differences
  setTimeout(() => { map.setZoom(START_ZOOM); map.invalidateSize(); }, 450);

  L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
    noWrap: true,
    attribution: '&copy; OSM contributors'
  }).addTo(map);

  // Outside-ROI mask
  const outer = [[90,-180],[90,180],[-90,180],[-90,-180]];
  const roi   = [[55.55,-10.80],[55.55,-5.30],[51.20,-5.30],[51.20,-10.80]];
  L.polygon([outer, roi], {stroke:false, fill:true, fillColor:'#e9f2f7', fillOpacity:0.75, interactive:false}).addTo(map);

  // D3 overlay
  const svgLayer = L.svg().addTo(map);
  const svg = d3.select('#map').select('svg');
  const gRings = svg.append('g').attr('class','rings');
  const gDots  = svg.append('g').attr('class','dots');

  // Styles / motion
  const RED='#b22222', BLUE='#1f5aa6', DOT_R=3, HIT_R_DOT=12, HIT_R_RING=24, EDGE_PAD=40, WOBBLE=0.35;
  const TRAVEL_MS=900, STAGGER=1;
  const DOTS_PER_TROLLEY=12, DOTS_PER_WARD=18;

  // Hover card
  const card = document.getElementById('card');
  function cardHTML(h){ return '<div class="h-name">'+h.name+'</div>'
      +'<div class="row"><div class="lab">Trolley</div><div class="val-t">'+(h.trolley||0).toLocaleString()+'</div></div>'
      +'<div class="row"><div class="lab">Ward</div><div class="val-w">'+(h.ward||0).toLocaleString()+'</div></div>'
      +'<div class="row" style="border-top:1px solid #cdd; padding-top:3px;"><div class="lab">Total</div><div class="val-all">'+((h.total||(h.trolley||0)+(h.ward||0))).toLocaleString()+'</div></div>'; }
  function showCardAtHospital(h){
    const ll=L.latLng(h.lat,h.lon);
    const pt=map.latLngToContainerPoint(ll);
    const rect=map.getContainer().getBoundingClientRect();
    const x=rect.left+pt.x, y=rect.top+pt.y;
    const z=map.getZoom();
    const s=Math.max(0.70, Math.min(1.35, 0.08 + 0.12*z)); // slightly larger at higher zoom
    card.style.transform='scale('+s+')';
    card.innerHTML=cardHTML(h);
    card.style.display='block';
    card.style.left=(x+12)+'px';
    card.style.top =(y+12)+'px';
  }
  function hideCard(){ card.style.display='none'; }
  map.on('dragstart', hideCard); map.on('zoomstart', hideCard);

  // Geometry helpers
  function project(lat,lon){ return map.latLngToLayerPoint(L.latLng(lat,lon)); }
  function spawnFromEdge(){
    const s=map.getSize(), w=s.x, h=s.y, side=['L','R','T','B'][Math.floor(Math.random()*4)];
    if (side==='L') return [ -EDGE_PAD, Math.random()*h ];
    if (side==='R') return [ w+EDGE_PAD, Math.random()*h ];
    if (side==='T') return [ Math.random()*w, -EDGE_PAD ];
    return [ Math.random()*w, h+EDGE_PAD ];
  }
  function buildTargets(lat,lon,trolley,ward){
    const p=project(lat,lon), left=[], right=[];
    const tDots=Math.max(0,Math.floor((trolley||0)/DOTS_PER_TROLLEY));
    const wDots=Math.max(0,Math.floor((ward||0)/DOTS_PER_WARD));

    // left serpentine (trolley)
    const rows=16, vSpacing=6, colStep=10, swayAmp=4;
    let placed=0, col=0;
    while(placed<tDots){
      const rowsThis=Math.min(rows,tDots-placed);
      const baseX=p.x-(18+12+col*colStep);
      for(let r=0;r<rowsThis;r++){
        const y=p.y+(r-rows/2+.5)*vSpacing;
        const sway=Math.sin((r/rows)*2*Math.PI)*swayAmp;
        left.push({x:baseX+sway,y});
      }
      col++; placed+=rowsThis;
    }

    // right grid (ward)
    const tlx=p.x+(18+24), tly=p.y-40, wardRows=8, colSpacing=12, rowSpacing=8;
    for(let i=0;i<wDots;i++){ const c=Math.floor(i/wardRows), r=i%wardRows; right.push({x:tlx+c*colSpacing,y:tly+r*rowSpacing}); }
    return {center:p,left,right};
  }

  const model = H.map(h => Object.assign({}, h));
  model.forEach(h => h.targets = buildTargets(h.lat,h.lon,h.trolley,h.ward));

  function drawRings(){
    gRings.selectAll('*').remove();
    model.forEach(h=>{
      const t=h.targets;
      gRings.append('circle').attr('cx',t.center.x).attr('cy',t.center.y).attr('r',18)
        .attr('fill','#f5f5f5').attr('stroke','#0a6536').attr('stroke-width',2);
      gRings.append('circle').attr('cx',t.center.x).attr('cy',t.center.y).attr('r',HIT_R_RING)
        .attr('fill','#fff').attr('fill-opacity',0.01).style('pointer-events','all').classed('leaflet-interactive', true)
        .on('mouseover', ev=>showCardAtHospital(h))
        .on('mousemove', ev=>showCardAtHospital(h))
        .on('mouseout', hideCard);

      // UHL pulse
      if (!h.pulseDiv && h.name.indexOf('Limerick')!==-1){
        const div=document.createElement('div'); div.className='uhl-pulse';
        const size=56; div.style.width=size+'px'; div.style.height=size+'px';
        map.getPanes().overlayPane.appendChild(div); h.pulseDiv=div;
      }
      if (h.pulseDiv){ const size=56; h.pulseDiv.style.left=(t.center.x-size/2)+'px'; h.pulseDiv.style.top=(t.center.y-size/2)+'px'; }
    });
  }

  // Dots + animation
  const nodes=[];
  model.forEach(h=>{
    const t=h.targets;
    t.left.forEach(pt=>{ const s=spawnFromEdge(); nodes.push({hid:h.name,kind:'t',color:RED,sx:s[0],sy:s[1],tx:pt.x,ty:pt.y}); });
    t.right.forEach(pt=>{ const s=spawnFromEdge(); nodes.push({hid:h.name,kind:'w',color:BLUE,sx:s[0],sy:s[1],tx:pt.x,ty:pt.y}); });
  });

  const groups = gDots.selectAll('g.dotg').data(nodes).enter().append('g').attr('class','dotg');
  groups.append('circle').attr('r',DOT_R).attr('cx',d=>d.sx).attr('cy',d=>d.sy).attr('fill',d=>d.color).style('opacity',0);
  groups.append('circle').attr('r',HIT_R_DOT).attr('cx',d=>d.sx).attr('cy',d=>d.sy)
    .attr('fill','#fff').attr('fill-opacity',0.01).style('pointer-events','all').classed('leaflet-interactive', true)
    .on('mouseover', (ev,d)=>{ const h=model.find(x=>x.name===d.hid); if(h) showCardAtHospital(h); })
    .on('mousemove', (ev,d)=>{ const h=model.find(x=>x.name===d.hid); if(h) showCardAtHospital(h); })
    .on('mouseout', hideCard);

  groups.select('circle:first-child').transition()
    .delay((d,i)=>i*STAGGER).duration(TRAVEL_MS).ease(d3.easeCubicOut)
    .style('opacity',1).attr('cx',d=>d.tx).attr('cy',d=>d.ty)
    .on('end', function(d){ const c=d3.select(this), base=d.ty;
      (function bob(){ c.transition().duration(1200).ease(d3.easeSinInOut).attr('cy',base+WOBBLE)
       .transition().duration(1200).ease(d3.easeSinInOut).attr('cy',base-WOBBLE).on('end',bob); })();
    });
  groups.select('circle:last-child').transition()
    .delay((d,i)=>i*STAGGER).duration(TRAVEL_MS).ease(d3.easeCubicOut)
    .attr('cx',d=>d.tx).attr('cy',d=>d.ty);

  let ANIM_DONE=false; setTimeout(()=>{ANIM_DONE=true;}, TRAVEL_MS+600);

  function reposition(){
    model.forEach(h=>{
      const t=buildTargets(h.lat,h.lon,h.trolley,h.ward); h.targets=t;
      if (h.pulseDiv){ const size=56; h.pulseDiv.style.left=(t.center.x-size/2)+'px'; h.pulseDiv.style.top=(t.center.y-size/2)+'px'; }
    });
    if (!ANIM_DONE){ drawRings(); return; }

    let idxT={}, idxW={}; model.forEach(h=>{idxT[h.name]=0; idxW[h.name]=0;});
    nodes.forEach(n=>{
      const h=model.find(x=>x.name===n.hid); if(!h) return; const t=h.targets;
      if (n.kind==='t'){ const i=idxT[h.name]++; const pt=t.left[Math.min(i,t.left.length-1)]||t.center; n.tx=pt.x; n.ty=pt.y; }
      else { const i=idxW[h.name]++; const pt=t.right[Math.min(i,t.right.length-1)]||t.center; n.tx=pt.x; n.ty=pt.y; }
    });
    groups.selectAll('circle:first-child').interrupt().attr('cx',d=>d.tx).attr('cy',d=>d.ty);
    groups.selectAll('circle:last-child').interrupt().attr('cx',d=>d.tx).attr('cy',d=>d.ty);
    drawRings();
  }

  drawRings();
  map.whenReady(()=>reposition());
  map.on('zoomend moveend', reposition);
</script>
</body>
</html>
